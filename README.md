# Каталог книг

Веб-приложение для управления каталогом книг и авторов, разработанное на фреймворке Yii2 с использованием современных практик разработки.

## Основной функционал

- **Управление книгами**: создание, редактирование, просмотр и удаление книг
- **Управление авторами**: полный CRUD функционал для авторов
- **Связи между сущностями**: многие-ко-многим между книгами и авторами
- **Система обложек**: загрузка, валидация и отображение обложек книг
- **Система подписок**: возможность подписаться на автора для получения уведомлений
- **SMS-уведомления**: автоматическая отправка SMS при добавлении новых книг автора
- **Отчетность**: ТОП-10 авторов по количеству книг за год
- **Аутентификация**: система входа/выхода пользователей

## Технические особенности

- **Фреймворк**: Yii2
- **База данных**: MySQL 8.0
- **PHP**: версия 8.2+
- **Архитектура**: Repository Pattern + Service Layer
- **Dependency Injection**: настроенный DI контейнер
- **Загрузка файлов**: отдельный FileUploadService с валидацией
- **SMS-сервис**: интеграция с SMSPilot API
- **Логирование**: PSR-совместимый логгер
- **Тестирование**: Codeception с полным покрытием

## Структура проекта

```
├── controllers/        # Контроллеры веб-интерфейса
├── models/            # ActiveRecord модели
├── services/          # Бизнес-логика
│   └── interfaces/    # Интерфейсы сервисов
├── repositories/      # Слой доступа к данным
│   └── interfaces/    # Интерфейсы репозиториев
├── forms/             # Формы валидации
├── views/             # Шаблоны представлений
├── config/            # Конфигурационные файлы
├── migrations/        # Миграции базы данных
└── docker/           # Docker конфигурация
```

## Требования

- PHP >= 8.3
- MySQL >= 8.0
- Composer
- Docker и Docker Compose (для контейнеризации)

## Установка

### С Docker (рекомендуется)

1. Клонируйте репозиторий:
```bash
git clone <repository-url>
cd usetech_test
```

2. Запустите контейнеры:
```bash
docker-compose up -d
```

3. Примените миграции:
```bash
docker-compose exec php php yii migrate
```

4. Создайте администратора:
```bash
docker-compose exec php php yii create-admin admin password123 admin@example.com
```

Приложение будет доступно по адресу: http://localhost:8081

### Локальная установка

1. Установите зависимости:
```bash
composer install
```

2. Настройте базу данных в `config/db.php`

3. Примените миграции:
```bash
php yii migrate
```

4. Создайте администратора:
```bash
php yii create-admin admin password123 admin@example.com
```

## Использование

### Веб-интерфейс

- **Главная страница**: просмотр каталога книг
- **Авторы**: список всех авторов с возможностью просмотра их книг
- **Административные функции**: доступны после авторизации
  - Добавление/редактирование книг и авторов
  - Управление связями книга-автор
  - Просмотр отчетов

### Система обложек книг

- **Загрузка обложек**: поддержка форматов JPG, PNG, GIF, WebP
- **Валидация файлов**: проверка размера (до 2MB) и типа файла
- **Автоматическая обработка**: уникальные имена файлов, безопасное хранение
- **Заглушка**: автоматическое отображение placeholder при отсутствии обложки
- **Адаптивный дизайн**: корректное отображение на всех устройствах

### Подписки на авторов

- Любой посетитель может подписаться на автора, указав номер телефона
- При добавлении новой книги автора всем подписчикам отправляется SMS
- Возможность отписки от уведомлений

### API для SMS

Настройте SMS-уведомления через SMSPilot:

1. Получите API ключ на [smspilot.ru](https://smspilot.ru/)
2. Добавьте в переменные окружения:
```bash
SMSPILOT_API_KEY=ваш_api_ключ
```

## Модели данных

### Book (Книга)
- Название, описание, год издания
- ISBN (уникальный)
- Связь с авторами (многие-ко-многим)

### Author (Автор)  
- Имя автора
- Связь с книгами (многие-ко-многим)
- Список подписчиков

### AuthorSubscription (Подписка)
- Связь с автором
- Номер телефона подписчика
- Опциональная связь с пользователем (для авторизованных)

### User (Пользователь)
- Система аутентификации
- Административные права

## Тестирование

Проект покрыт комплексными unit и интеграционными тестами с использованием фреймворка Codeception.

### Структура тестов

```
tests/
├── unit/
│   ├── models/           # Тесты моделей
│   ├── services/         # Тесты сервисов
│   ├── repositories/     # Тесты репозиториев
│   └── integration/      # Интеграционные тесты
├── _data/               # Фикстуры для тестов
├── _fixtures/           # Классы фикстур
└── _support/            # Вспомогательные классы
```

### Запуск тестов

#### С Docker (рекомендуется)

1. **Запуск всех тестов**:
```bash
docker compose exec php ./vendor/bin/codecept run unit
```

2. **Запуск конкретной группы тестов**:
```bash
# Тесты сервисов
docker compose exec php ./vendor/bin/codecept run unit services/

# Тесты репозиториев
docker compose exec php ./vendor/bin/codecept run unit repositories/

# Интеграционные тесты
docker compose exec php ./vendor/bin/codecept run unit integration/
```

3. **Запуск конкретного теста**:
```bash
docker compose exec php ./vendor/bin/codecept run unit services/BookServiceTest
```

4. **Запуск с подробным выводом**:
```bash
docker compose exec php ./vendor/bin/codecept run unit --debug
```

#### Локальный запуск

1. **Настройка тестовой БД**:
```bash
# Создайте тестовую базу данных
mysql -u root -p -e "CREATE DATABASE book_catalog_test;"

# Настройте подключение в config/test_db.php
```

2. **Инициализация тестовой БД**:
```bash
php tests/bin/init-test-db.php
```

3. **Запуск тестов**:
```bash
./vendor/bin/codecept run unit
```

### Покрытие тестами

Проект включает тесты для:

- **Модели**: валидация, связи, бизнес-правила
- **Сервисы**: бизнес-логика, обработка ошибок
- **Репозитории**: операции с БД, транзакции
- **Интеграционные сценарии**: полные пользовательские сценарии
- **Система обложек**: загрузка, валидация, отображение файлов
- **SMS-уведомления**: отправка уведомлений подписчикам
- **Отчеты**: генерация ТОП-10 авторов

### Фикстуры

Тесты используют фикстуры для создания тестовых данных:

- `UserFixture` - тестовые пользователи
- `AuthorFixture` - авторы
- `BookFixture` - книги
- `BookAuthorFixture` - связи книга-автор
- `AuthorSubscriptionFixture` - подписки на авторов

### Тестовая БД

Для тестов используется отдельная база данных `book_catalog_test`, которая:

- Автоматически очищается перед каждым тестом
- Заполняется фикстурами
- Изолирована от основной БД
- Использует транзакции для быстрого отката изменений

### Примеры команд

```bash
# Запуск всех тестов с покрытием
docker compose exec php ./vendor/bin/codecept run unit --coverage

# Запуск только тестов обложек книг
docker compose exec php ./vendor/bin/codecept run unit services/FileUploadServiceTest

# Запуск интеграционных тестов бизнес-логики
docker compose exec php ./vendor/bin/codecept run unit integration/IntegrationBusinessLogicTest

# Запуск с детальным выводом для отладки
docker compose exec php ./vendor/bin/codecept run unit --debug --verbose
```

## Docker окружение

Проект включает готовую Docker конфигурацию:

- **PHP 8.2** с необходимыми расширениями
- **Nginx** веб-сервер
- **MySQL 8.0** основная БД
- **MySQL test** отдельная БД для тестирования

Все сервисы настроены и готовы к работе из коробки.

## Лицензия

MIT
